# Prepare Datasets for MAFT-OVSeg

The data should be organized like:
```bash
$datasets/
  ade/
      ADEChallengeData2016/
      ADE20K_2021_17_01/
  coco/
  VOCdevkit/
      VOC2012/
      VOC2010/
  
```

You can set the location for builtin datasets by `export DETECTRON2_DATASETS=/path/to/datasets`.
If left unset, the default is `./datasets` under the MAFT project directory.


## Expected dataset structure for [COCO](https://cocodataset.org/#download):

The COCO dataset should be organized like:
```bash
 coco/
      #http://images.cocodataset.org/zips/train2017.zip
      train2017/ 
      #http://images.cocodataset.org/zips/val2017.zip
      val2017/   
      #http://images.cocodataset.org/annotations/annotations_trainval2017.zip
      annotations/ 
        instances_{train,val}2017.json
        panoptic_{train,val}2017.json
        captions_{train,val}2017.json
      #http://calvin.inf.ed.ac.uk/wp-content/uploads/data/cocostuffdataset/stuffthingmaps_trainval2017.zip
      stuffthingmaps/
      # generate by prepare_coco_stuff_sem_seg.py
      stuffthingmaps_detectron2/
```

1. Download the dataset from http://cocodataset.org/#download:
```bash
cd $datasets
wget http://images.cocodataset.org/zips/train2017.zip
unzip train2017.zip -d coco/
wget http://images.cocodataset.org/zips/val2017.zip 
unzip val2017.zip -d coco/
wget http://images.cocodataset.org/annotations/annotations_trainval2017.zip
unzip annotations_trainval2017.zip -d coco/
wget http://images.cocodataset.org/annotations/panoptic_annotations_trainval2017.zip
unzip panoptic_annotations_trainval2017.zip -d coco/
unzip coco/annotations/panoptic_train2017.zip -d coco/
unzip coco/annotations/panoptic_val2017.zip -d coco/
```

2. Generate the semantic segmentation annotations `coco/stuffthingmaps_detectron2/` by running:
```bash
python datasets/prepare_coco_stuff_sem_seg.py
``` 


## Expected dataset structure for [ADE20k (A-150)](http://sceneparsing.csail.mit.edu/) and [ADE20k-Full (A-847)](https://groups.csail.mit.edu/vision/datasets/ADE20K/):
```bash
ade/
  ADEChallengeData2016/
    images/
    annotations/
    objectInfo150.txt
    # downloaded instance annotation
    annotations_instance/
    # generated by prepare_ade20k_sem_seg.py
    annotations_detectron2/
    # generated by prepare_ade20k_ins_seg.py
    ade20k_instance_{train,val}.json
    # generated by prepare_ade20k_pan_seg.py
    ade20k_panoptic_{train,val}.json
    ade20k_panoptic_{train,val}/
    
  ADE20K_2021_17_01/
    images/
    index_ade20k.pkl
    objects.txt
    # generated by prepare_ade20k_full_sem_seg.py
    images_detectron2/
    annotations_detectron2/
    
```

### ADE20k(A-150)

Download the dataset from http://sceneparsing.csail.mit.edu/:
```bash
cd $datasets
wget http://data.csail.mit.edu/places/ADEchallenge/ADEChallengeData2016.zip
# generate folder ade/ADEChallengeData2016/
unzip ADEChallengeData2016.zip -d ade/
```

Download the instance annotations from http://sceneparsing.csail.mit.edu/:
```bash
cd $datasets
wget http://sceneparsing.csail.mit.edu/data/ChallengeData2017/annotations_instance.tar
# generate folder ade/ADEChallengeData2016/annotations_instance/
tar -xvf annotations_instance.tar -C ade/ADEChallengeData2016/
```

Generate the directory `ade/ADEChallengeData2016/annotations_detectron2` by running: 
```bash
python datasets/prepare_ade20k_sem_seg.py
```


### ADE20k-Full(A-847)

Register and download the dataset from https://groups.csail.mit.edu/vision/datasets/ADE20K/:
```bash
cd $datasets
wget your/personal/download/link/{username}_{hash}.zip
unzip {username}_{hash}.zip -d ade/
```

Generate the directories ade/ADE20K_2021_17_01/annotations_detectron2` by running: 
```bash
python datasets/prepare_ade20k_full_sem_seg.py
```

## Expected dataset structure for [PASCAL Context (PC-59)](https://www.cs.stanford.edu/~roozbeh/pascal-context/), [PASCAL Context Full (PC-459)](https://www.cs.stanford.edu/~roozbeh/pascal-context/) and [PASCAL VOC (PAS-20)](http://host.robots.ox.ac.uk/pascal/VOC/):

```bash
VOCdevkit/
  VOC2012/
    Annotations/
    JPEGImages/
    ImageSets/
      Segmentation/
    # generated by prepare_pascal_voc_sem_seg.py
    annotations_ovs/
  VOC2010/
    JPEGImages/
    trainval/
    trainval_merged.json
    annotations_detectron2_ovs/
        # generated by prepare_pascal_ctx_sem_seg.py
        pc59_val
        # generated by prepare_pascal_ctx_full_sem_seg.py
        pc459_val
```
### PASCAL VOC (PAS-20)

Download the dataset from http://host.robots.ox.ac.uk/pascal/VOC/:
```bash
cd $datasets
wget http://host.robots.ox.ac.uk/pascal/VOC/voc2012/VOCtrainval_11-May-2012.tar
# generate folder VOCdevkit/VOC2012
tar -xvf VOCtrainval_11-May-2012.tar
```

Generate directory `annotations_ovs` running: 
```bash
python datasets/prepare_pascal_voc_sem_seg.py
```

### PASCAL Context (PC-59)

Download the dataset from http://host.robots.ox.ac.uk/pascal/VOC/ and annotation from https://www.cs.stanford.edu/~roozbeh/pascal-context/:
```bash
cd $datasets
wget http://host.robots.ox.ac.uk/pascal/VOC/voc2010/VOCtrainval_03-May-2010.tar
# generate folder VOCdevkit/VOC2010
tar -xvf VOCtrainval_03-May-2010.tar 
wget https://www.cs.stanford.edu/~roozbeh/pascal-context/trainval.tar.gz
# generate folder VOCdevkit/VOC2010/trainval
tar -xvzf trainval.tar.gz -C VOCdevkit/VOC2010 
wget https://codalabuser.blob.core.windows.net/public/trainval_merged.json -P VOCdevkit/VOC2010/
```

Install [Detail API](https://github.com/zhanghang1989/detail-api) by:
```bash
git clone https://github.com/zhanghang1989/detail-api.git
rm detail-api/PythonAPI/detail/_mask.c
pip install -e detail-api/PythonAPI/
```

Generate directory `annotations_detectron2_ovs/pc59_val` by running:
```bash
python datasets/prepare_pascal_ctx_sem_seg.py
```

### PASCAL Context Full (PC-459)

Generate directory `annotations_detectron2_ovs/pc459_val` by running:
```bash
python datasets/prepare_pascal_ctx_full_sem_seg.py
```
